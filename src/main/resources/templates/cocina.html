<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cocina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: url('/img/loloyta-banner1.jpg') no-repeat center center fixed;
            background-size: cover;
            overflow-x: hidden;
        }

        .nav-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 20px;
            width: 100%;
            z-index: 999;
        }

        .nav-content {
            display: flex;
            align-items: center;
        }

        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            border-radius: 50px;
            padding: 12px 24px;
            margin: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #111;
            font-weight: 500;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            min-width: 56px;
            height: 48px;
        }

        .glass.logo {
            padding: 0;
            width: 48px;
            height: 48px;
        }

        .bar-logo {
            width: 70%;
            height: 70%;
            border-radius: 50%;
            object-fit: cover;
        }

        .bar-button {
            text-decoration: none;
            color: #111;
            font-size: 1rem;
            font-weight: 500;
        }

        .contenido {
            padding-top: 120px;
            padding-bottom: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .mesa-table {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .mesa-table th {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            padding: 12px 16px;
            text-align: left;
        }

        .mesa-table td {
            border: none;
            padding: 12px 16px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.9);
            color: #111;
        }

        .mesa-table td:nth-child(1),
        .mesa-table td:nth-child(4) {
            text-align: right;
        }

        .mesa-table td:nth-child(2),
        .mesa-table td:nth-child(3),
        .mesa-table td:nth-child(5) {
            text-align: left;
        }

        .form-select {
            border-radius: 30px;
            padding: 6px 16px;
            font-weight: 500;
        }

        .btn-lg {
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 30px;
            padding: 10px 30px;
        }
    </style>
</head>
<body>
<!-- NavBar estilo Dynamic Island -->
<div class="nav-container">
    <div class="nav-content">
        <div class="glass">
            <a href="/registro" class="bar-button">Cerrar Sesión</a>
        </div>
        <div class="glass" style="width: 340px;">
            <span>Panel de Cocina</span>
        </div>
        <div class="glass logo">
            <img src="../img/loloyta-logo.png" alt="Logo" class="bar-logo" />
        </div>
    </div>
</div>

<div class="container contenido">
    <h2 class="text-center mb-4 text-light fw-semibold">Pedidos en Cocina</h2>
    <div class="table-responsive mesa-table">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Detalle</th>
                    <th>Mesa</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody id="tablaCocina">
                <!-- Llenado por controlador/JS -->
            </tbody>
        </table>
    </div>
    <div class="text-center mt-4">
        <button class="btn btn-success btn-lg" onclick="guardarCambios()">Guardar</button>
    </div>
</div>

<!-- WebSocket Script -->
<script>
    let stompClient = null;

    function conectar() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log("Conectado al WebSocket de pedidos: " + frame);

            // Suscripción para recibir nuevos pedidos o actualizaciones
            stompClient.subscribe('/topic/recibirPedido', function (mensaje) {
                const pedido = JSON.parse(mensaje.body);
                console.log("Pedido recibido/actualizado via WebSocket (cocina):", pedido);
                agregarOActualizarPedidoATabla(pedido);
            });

            // Suscripción para pedidos eliminados
            stompClient.subscribe('/topic/pedidoEliminado', function (mensaje) {
                const idEliminado = parseInt(mensaje.body);
                console.log("Pedido eliminado recibido via WebSocket (cocina), ID:", idEliminado);
                const filaAEliminar = document.querySelector(`#tablaCocina tr[data-id="${idEliminado}"]`);
                if (filaAEliminar) {
                    filaAEliminar.remove();
                    console.log(`Pedido con ID ${idEliminado} eliminado de la tabla.`);
                }
            });

            // Suscripción para cambios de estado (activo/inactivo)
            stompClient.subscribe('/topic/estadoCambiado', function (mensaje) {
                const pedidoActualizado = JSON.parse(mensaje.body); // Ahora recibimos el objeto Cocina completo
                console.log(`Estado de pedido ${pedidoActualizado.id} cambiado a ${pedidoActualizado.activo} via WebSocket (cocina).`);
                const fila = document.querySelector(`#tablaCocina tr[data-id="${pedidoActualizado.id}"]`);
                if (fila) {
                    const selectEstado = fila.querySelector('select[name="estado"]');
                    if (selectEstado) {
                        selectEstado.value = pedidoActualizado.activo.toString();
                        fila.dataset.activo = pedidoActualizado.activo.toString(); // Actualizar el dataset para la lógica de guardarCambios
                    }
                }
            });
        }, function(error) {
            console.error("Error de conexión WebSocket (cocina):", error);
            setTimeout(conectar, 5000); // Intentar reconectar
        });
    }

    // Función para añadir o actualizar un pedido en la tabla de la cocina
    function agregarOActualizarPedidoATabla(pedido) {
        const tbody = document.getElementById('tablaCocina');
        let filaExistente = document.querySelector(`#tablaCocina tr[data-id="${pedido.id}"]`);

        if (filaExistente) {
            // Actualizar fila existente
            filaExistente.querySelector('td:nth-child(2)').innerText = pedido.nombre; // Nombre
            filaExistente.querySelector('td:nth-child(3)').innerText = pedido.detalle; // Detalle
            filaExistente.querySelector('td:nth-child(4)').innerText = pedido.numeroMesa; // Mesa
            const selectEstado = filaExistente.querySelector('select[name="estado"]');
            if (selectEstado) {
                selectEstado.value = pedido.activo.toString();
            }
            filaExistente.dataset.activo = pedido.activo.toString(); // Actualizar el dataset
            console.log(`Pedido con ID ${pedido.id} actualizado en la tabla de cocina.`);
        } else {
            // Añadir nueva fila
            const fila = document.createElement('tr');
            fila.setAttribute('data-id', pedido.id);
            fila.setAttribute('data-activo', pedido.activo); // Añadir data-activo para la lógica de guardarCambios

            fila.innerHTML = `
                <td>${pedido.id}</td>
                <td>${pedido.nombre}</td>
                <td>${pedido.detalle}</td>
                <td>${pedido.numeroMesa}</td>
                <td>
                    <select class="form-select" name="estado">
                        <option value="true" ${pedido.activo ? 'selected' : ''}>Recibido</option>
                        <option value="false" ${!pedido.activo ? 'selected' : ''}>Preparando..</option>
                    </select>
                </td>
            `;
            tbody.appendChild(fila);
            console.log(`Nuevo pedido con ID ${pedido.id} añadido a la tabla de cocina.`);
        }
    }

    window.onload = conectar;

    function guardarCambios() {
        document.querySelectorAll("#tablaCocina tr").forEach(tr => {
            const id = tr.getAttribute("data-id");
            const selectEstado = tr.querySelector("select[name=estado]");
            const estadoSeleccionado = selectEstado.value === "true"; // Estado que el usuario ha seleccionado
            const estadoActualEnFila = tr.dataset.activo === "true"; // Estado actual del pedido en la fila (refleja la BD)

            // Solo enviar la actualización si el estado seleccionado es diferente al estado actual del pedido en la fila
            if (estadoSeleccionado !== estadoActualEnFila) {
                fetch(`/cocina/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activo: estadoSeleccionado }) // Solo enviamos el campo 'activo'
                }).then(response => {
                    if (response.ok) {
                        console.log(`Estado del pedido ${id} actualizado a ${estadoSeleccionado} en BD.`);
                        // Actualizar el dataset.activo de la fila para reflejar el nuevo estado
                        tr.dataset.activo = estadoSeleccionado.toString();
                        // El mensaje WebSocket para actualizar el estado en otras vistas ya se envía desde el controlador
                    } else {
                        console.error(`Error al actualizar el estado del pedido ${id} en BD.`);
                        alert(`Error al actualizar el estado del pedido ${id}.`);
                    }
                }).catch(error => console.error('Error en la solicitud PUT:', error));
            } else {
                console.log(`Estado del pedido ${id} no ha cambiado, no se envía actualización.`);
            }
        });
        alert("Cambios de estado guardados correctamente (si hubo alguno).");
    }
</script>

</body>
</html>